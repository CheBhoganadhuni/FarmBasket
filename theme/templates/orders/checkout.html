{% extends 'base.html' %}

{% block title %}Checkout - FarmBasket{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-white py-12 px-4" x-data="checkoutPage()">
    <div class="container mx-auto max-w-7xl">
        
        <!-- Header -->
        <div class="mb-8">
            <h1 class="font-display text-4xl font-bold mb-2">üõí Checkout</h1>
            <p class="text-gray-600">Complete your order</p>
        </div>
        
        <!-- Loading -->
        <template x-if="loading">
            <div class="text-center py-20">
                <div class="text-6xl mb-4">‚è≥</div>
                <p class="text-xl">Loading checkout...</p>
            </div>
        </template>
        
        <!-- Checkout Form -->
        <template x-if="!loading && cart">
            <form @submit.prevent="placeOrder" class="grid md:grid-cols-3 gap-6">
                
                <!-- Left Column: Forms -->
                <div class="md:col-span-2 space-y-6">
                    
                    <!-- Delivery Address -->
                    <div class="glass rounded-xl p-6">
                        <h2 class="font-display text-2xl font-bold mb-4">üìç Delivery Address</h2>
                        
                        <!-- Saved Addresses -->
                        <div x-show="addresses.length > 0" class="mb-6">
                            <label class="block text-sm font-semibold mb-2">Choose saved address:</label>
                            <select x-model="selectedAddressId" @change="fillAddressFromSaved" 
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none">
                                <option value="">Enter new address</option>
                                <template x-for="addr in addresses" :key="addr.id">
                                    <option :value="addr.id" x-text="`${addr.label} - ${addr.street_address}, ${addr.city}`"></option>
                                </template>
                            </select>
                        </div>
                        
						
                        <!-- Address Form -->
                        


						
						<div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Full Name *</label>
                                <input type="text" x-model="address.name" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Phone Number *</label>
                                <input type="tel" x-model="address.phone" required pattern="[0-9]{10}"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold mb-2">Address *</label>
                                <textarea x-model="address.address" required rows="3"
                                          class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">City *</label>
                                <input type="text" x-model="address.city" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">State *</label>
                                <input type="text" x-model="address.state" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Postal Code *</label>
                                <input type="text" x-model="address.postal_code" required pattern="[0-9]{6}"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Landmark (Optional)</label>
                                <input type="text" x-model="address.landmark"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    <div class="glass rounded-xl p-6">
                        <h2 class="font-display text-2xl font-bold mb-4">üí≥ Payment Method</h2>
                        
                        <div class="space-y-3">
                            <!-- Razorpay -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="paymentMethod === 'RAZORPAY' ? 'border-neon bg-green-50' : 'border-gray-300 hover:bg-gray-50'">
                                <input type="radio" x-model="paymentMethod" value="RAZORPAY" class="mr-3">
                                <div>
                                    <div class="font-semibold">üí≥ Pay Online (Razorpay)</div>
                                    <div class="text-sm text-gray-600">UPI, Cards, Wallets, NetBanking</div>
                                </div>
                            </label>
                            
                            <!-- COD -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="paymentMethod === 'COD' ? 'border-neon bg-green-50' : 'border-gray-300 hover:bg-gray-50'">
                                <input type="radio" x-model="paymentMethod" value="COD" class="mr-3">
                                <div>
                                    <div class="font-semibold">üíµ Cash on Delivery</div>
                                    <div class="text-sm text-gray-600">Pay when you receive</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
					<!-- Test Payment Info -->
					<!-- <div x-show="useTestPayment" class="glass rounded-xl p-6 bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500"> -->
						<!-- <h3 class="font-bold text-blue-800 dark:text-blue-400 mb-3">üß™ Test Payment Instructions</h3> -->
						<!-- <div class="text-sm text-blue-700 dark:text-blue-300 space-y-2"> -->
							<!-- <p class="font-semibold">Use these test credentials:</p> -->
							
							<!-- <p class="mt-2"><strong>Test UPI:</strong> <code class="bg-white dark:bg-gray-800 px-2 py-1 rounded">success@razorpay</code></p> -->
							
							<!-- <p class="text-red-600 dark:text-red-400 font-semibold mt-3">‚ö†Ô∏è Don't scan QR codes in test mode!</p> -->
						<!-- </div> -->
					<!-- </div> -->

					
                    <!-- Order Notes -->
                    <div class="glass rounded-xl p-6">
                        <h2 class="font-display text-2xl font-bold mb-4">üìù Order Notes (Optional)</h2>
                        <textarea x-model="orderNotes" rows="3" placeholder="Any special instructions..."
                                  class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none"></textarea>
                    </div>
                    
                    <!-- ‚úÖ Test Payment Toggle -->
                    <!-- <div x-show="testModeEnabled" class="glass rounded-xl p-6 bg-yellow-50 border-2 border-yellow-500"> -->
                        <!-- <label class="flex items-center cursor-pointer"> -->
                            <!-- <input type="checkbox" x-model="useTestPayment" class="mr-3"> -->
                            <!-- <div> -->
                                <!-- <div class="font-semibold text-yellow-800">üß™ Test Payment Mode (‚Çπ1 Only)</div> -->
                                <!-- <div class="text-sm text-yellow-700">Enable this to test with ‚Çπ1 payment instead of full amount</div> -->
                            <!-- </div> -->
                        <!-- </label> -->
                    <!-- </div> -->
                </div>
                
                <!-- Right Column: Order Summary -->
                <div class="glass rounded-xl p-6 h-fit sticky top-24">
                    <h2 class="font-display text-2xl font-bold mb-6">Order Summary</h2>
                    
                    <!-- Items -->
                    <div class="space-y-3 mb-6 max-h-60 overflow-y-auto">
                        <template x-for="item in cart.items" :key="item.id">
                            <div class="flex gap-3">
                                <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                                    <img x-show="item.product_image" :src="item.product_image" :alt="item.product_name" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-sm line-clamp-1" x-text="item.product_name"></div>
                                    <div class="text-sm text-gray-600">Qty: <span x-text="item.quantity"></span></div>
                                    <div class="font-bold text-neon">‚Çπ<span x-text="item.total_price"></span></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Pricing -->
					<div class="space-y-3 border-t pt-4">
						<div class="flex justify-between text-gray-600">
							<span>Subtotal</span>
							<span>‚Çπ<span x-text="cart.subtotal"></span></span>
						</div>
						<div class="flex justify-between text-gray-600">
							<span>Delivery</span>
							<span x-show="deliveryCharge > 0">‚Çπ<span x-text="deliveryCharge"></span></span>
							<span x-show="deliveryCharge === 0" class="text-green-600">FREE</span>
						</div>
						<div class="flex justify-between text-gray-600">
							<span>Processing Fee Of ‚Çπ1 Mandatory</span>
						</div>
						<!-- <div x-show="useTestPayment" class="flex justify-between text-yellow-600"> -->
							<!-- <span>Test Discount</span> -->
							<!-- <span>-‚Çπ<span x-text="(parseFloat(cart.subtotal) + deliveryCharge - 1).toFixed(2)"></span></span> -->
						<!-- </div> -->
						<div x-show="useWallet" class="flex justify-between text-green-600">
							<span>Wallet Deduction</span>
							<span>-‚Çπ<span x-text="walletDeduction.toFixed(2)"></span></span>
						</div>
						<div class="border-t pt-3 flex justify-between font-bold text-xl">
							<span>Total</span>
							<span class="text-neon">‚Çπ<span x-text="payableAmount"></span></span>
						</div>
					</div>
                    
					<!-- Wallet Balance and Use Wallet -->
					<div class="glass rounded-xl p-6 mb-6">
						<h3 class="font-semibold mb-2">Wallet</h3>
						<p>Available balance: ‚Çπ <span x-text="walletBalance.toFixed(2)"></span></p>
						<label class="inline-flex items-center mt-2">
							<input type="checkbox" x-model="useWallet" class="form-checkbox h-5 w-5 text-green-500" />
							<span class="ml-2">Use wallet balance for this order</span>
						</label>
					</div>

					
                    <!-- Place Order Button -->
                    <button type="submit" :disabled="placing"
                            class="w-full mt-6 px-6 py-4 bg-neon text-white rounded-lg hover:bg-green-600 transition font-semibold text-lg disabled:opacity-50">
                        <span x-show="!placing">Place Order üöÄ</span>
                        <span x-show="placing">Processing, Do Not Click Anything...</span>
                    </button>
                    
                    <!-- Trust Badges -->
                    <div class="mt-6 pt-6 border-t space-y-2 text-sm text-gray-600">
                        <div class="flex items-center gap-2">
                            <span>üîí</span>
                            <span>Secure checkout</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span>‚Ü©Ô∏è</span>
                            <span>Easy returns</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span>‚úì</span>
                            <span>Quality guaranteed</span>
                        </div>
                    </div>
                </div>
            </form>
        </template>
        
        <!-- Empty Cart -->
        <template x-if="!loading && !cart">
            <div class="text-center py-20">
                <div class="text-6xl mb-4">üõí</div>
                <h3 class="text-2xl font-bold mb-2">Your cart is empty</h3>
                <p class="text-gray-600 mb-6">Add items before checkout</p>
                <a href="/products/" class="inline-block px-6 py-3 bg-neon text-white rounded-lg hover:bg-green-600 transition font-semibold">
                    Browse Products
                </a>
            </div>
        </template>
    </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
function checkoutPage() {
    return {
        cart: null,
        addresses: [],
        loading: true,
        placing: false,
        selectedAddressId: '',
        paymentMethod: 'RAZORPAY',
        orderNotes: '',
        useTestPayment: false,
        testModeEnabled: true, // Will be set from backend
        address: {
            name: '',
            phone: '',
            address: '',
            city: '',
            state: '',
            postal_code: '',
            landmark: ''
        },
        walletBalance: 0,
        useWallet: false,
		
		get walletDeduction() {
            // Deduct min of walletBalance or order subtotal + deliveryCharge - 1 (platform fee)
            if (!this.useWallet) return 0;
            const maxDeductable = Math.max(0, parseFloat(this.cart.subtotal) + this.deliveryCharge - 1);
            return Math.min(this.walletBalance, maxDeductable);
        },
		get payableAmount() {
            // Total amount after wallet deduction, minimum 1 for platform fee or test payment 1
            <!-- if (this.useTestPayment) return '1.00'; -->
            const total = parseFloat(this.cart.subtotal) + this.deliveryCharge + 1 - this.walletDeduction;
            return (total < 1 ? 1 : total).toFixed(2);
        },
        get deliveryCharge() {
            if (!this.cart) return 0;
            return parseFloat(this.cart.subtotal) >= 500 ? 0 : 40;
        },
        
		
        async init() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/login/?next=/checkout/';
                return;
            }
            await this.loadWallet();            
            await this.fetchCart();
            await this.fetchAddresses();
            await this.fetchUserProfile();
        },
        
		async loadWallet() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch('/api/wallet/balance', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    this.walletBalance = data.balance;
                }
            } catch(err){
                console.error('Failed to load wallet', err);
            }
        },
		
        async fetchCart() {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch('/api/cart/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    this.cart = await response.json();
                    
                    if (this.cart.items.length === 0) {
                        this.cart = null;
                    }
                }
            } catch (err) {
                console.error('Failed to fetch cart', err);
            } finally {
                this.loading = false;
            }
        },
        
        async fetchAddresses() {
            const token = localStorage.getItem('access_token');
            if (!token) return;
            try {
                const response = await fetch('/api/auth/addresses', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    this.addresses = await response.json();
                }
            } catch (err) {
                console.error('Failed to fetch addresses', err);
            }
        },
        
        async fetchUserProfile() {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    
                    // Pre-fill name and phone if not already filled
                    if (!this.address.name) {
                        this.address.name = user.full_name;
                    }
                    if (!this.address.phone) {
                        this.address.phone = user.phone || '';
                    }
                }
            } catch (err) {
                console.error('Failed to fetch user profile', err);
            }
        },
        
		fillAddressFromSaved() {
			if (!this.selectedAddressId) {
				// Reset form but keep user's name and phone
				const savedName = this.address.name;
				const savedPhone = this.address.phone;
				
				this.address = {
					name: savedName,
					phone: savedPhone,
					address: '',
					city: '',
					state: '',
					postal_code: '',
					landmark: ''
				};
				return;
			}
			
			const selected = this.addresses.find(a => a.id === this.selectedAddressId);
			if (selected) {
				this.address = {
					name: this.address.name,  // ‚úÖ Keep original name from profile
					phone: selected.phone || this.address.phone,  // Use saved phone or keep profile phone
					address: selected.street_address,
					city: selected.city,
					state: selected.state,
					postal_code: selected.postal_code,
					landmark: selected.landmark || ''
				};
			}
		},

        
        async placeOrder() {
            // Validate form
            if (!this.address.name || !this.address.phone || !this.address.address || 
                !this.address.city || !this.address.state || !this.address.postal_code) {
                window.showNotification({
                    type: 'warning',
                    title: 'Incomplete Address',
                    message: 'Please fill all required address fields'
                });
                return;
            }
            
            if (!this.paymentMethod) {
                window.showNotification({
                    type: 'warning',
                    title: 'Select Payment Method',
                    message: 'Please select a payment method'
                });
                return;
            }
            
            this.placing = true;
            
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch('/api/checkout/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        delivery_address: {
                            address_id: this.selectedAddressId || null,
                            name: this.address.name,
                            phone: this.address.phone,
                            address: this.address.address,
                            city: this.address.city,
                            state: this.address.state,
                            postal_code: this.address.postal_code,
                            landmark: this.address.landmark
                        },
                        payment_method: this.paymentMethod,
                        order_notes: this.orderNotes,
                        use_wallet: this.useWallet,
						payable_amount: parseFloat(this.payableAmount)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.payment_required) {
                        // Open Razorpay
                        this.openRazorpay(data.razorpay_data, data.order_id);
                    } else {
                        // COD - redirect to success page
                        window.location.href = `/order/success/${data.order_id}/`;
                    }
                } else {
                    window.showNotification({
                        type: 'error',
                        title: 'Order Failed',
                        message: data.message
                    });
                    this.placing = false;
                }
            } catch (err) {
                console.error('Failed to place order', err);
                window.showNotification({
                    type: 'error',
                    title: 'Error',
                    message: 'Failed to place order. Please try again.'
                });
                this.placing = false;
            }
        },
        
        openRazorpay(razorpayData, orderId) {
            const options = {
                key: razorpayData.key_id,
                amount: razorpayData.amount,
                currency: razorpayData.currency,
                name: 'FarmBasket',
                description: `Order #${razorpayData.order_number}`,
                image: '/static/logo.png', // Add your logo here
                order_id: razorpayData.razorpay_order_id,
                prefill: {
                    name: razorpayData.customer_name,
                    email: razorpayData.customer_email,
                    contact: razorpayData.customer_phone
                },
                theme: {
                    color: '#4ade80'
                },
                handler: (response) => {
                    // Payment successful
                    this.verifyPayment(orderId, response);
                },
                modal: {
                    ondismiss: () => {
                        // Payment cancelled
                        this.placing = false;
                        window.showNotification({
                            type: 'warning',
                            title: 'Payment Cancelled',
                            message: 'You cancelled the payment. Your order is still pending.'
                        });
                    }
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
        },
        
        async verifyPayment(orderId, razorpayResponse) {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch('/api/payment/verify', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        razorpay_order_id: razorpayResponse.razorpay_order_id,
                        razorpay_payment_id: razorpayResponse.razorpay_payment_id,
                        razorpay_signature: razorpayResponse.razorpay_signature
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Payment verified - redirect to success page
                    window.location.href = `/order/success/${orderId}/`;
                } else {
                    window.showNotification({
                        type: 'error',
                        title: 'Payment Verification Failed',
                        message: data.message
                    });
                    this.placing = false;
                }
            } catch (err) {
                console.error('Failed to verify payment', err);
                window.showNotification({
                    type: 'error',
                    title: 'Error',
                    message: 'Payment verification failed. Please contact support.'
                });
                this.placing = false;
            }
        }
    }
}
</script>
{% endblock %}

