{% extends 'base.html' %}

{% block title %}Set New Password - FarmBasket{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 bg-gradient-to-br from-green-50 to-white">
    <div class="max-w-md w-full">
        
        <div class="glass rounded-2xl shadow-2xl p-8" x-data="confirmForm()">
            
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üîë</div>
                <h2 class="font-display text-3xl font-bold mb-2">Set New Password</h2>
                <p class="text-gray-600">Choose a strong password for your account</p>
            </div>
            
            <!-- Success Message -->
            <div x-show="success" x-transition class="mb-6 p-4 bg-green-100 text-green-700 rounded-lg text-center">
                <div class="mb-4">‚úì Password reset successful!</div>
                <a href="{% url 'accounts:login' %}" class="text-neon hover:underline font-semibold">Go to Login ‚Üí</a>
            </div>
            
            <!-- Error Message -->
            <div x-show="error" x-transition class="mb-6 p-4 bg-red-100 text-red-700 rounded-lg">
                <span x-text="error"></span>
            </div>
            
            <!-- Form -->
            <form @submit.prevent="submitConfirm" x-show="!success">
                
                <input type="hidden" x-model="token" value="{{ token }}">
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">New Password</label>
                    <div class="relative">
                        <input 
                            :type="showPassword ? 'text' : 'password'"
                            x-model="formData.new_password"
                            @input="validatePassword"
                            class="w-full px-4 py-3 border-2 rounded-lg focus:border-neon focus:outline-none transition"
                            :class="{ 'border-red-500': passwordError, 'border-gray-300': !passwordError }"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                        >
                        <button 
                            type="button"
                            @click="showPassword = !showPassword"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">
                            <span x-show="!showPassword">üëÅÔ∏è</span>
                            <span x-show="showPassword">üëÅÔ∏è‚Äçüó®Ô∏è</span>
                        </button>
                    </div>
                    <p x-show="passwordError" x-text="passwordError" class="text-red-500 text-sm mt-1"></p>
                    
                    <!-- Password Strength -->
                    <div class="mt-2 flex gap-1">
                        <div class="flex-1 h-2 rounded-full" :class="passwordStrength >= 1 ? 'bg-red-500' : 'bg-gray-200'"></div>
                        <div class="flex-1 h-2 rounded-full" :class="passwordStrength >= 2 ? 'bg-yellow-500' : 'bg-gray-200'"></div>
                        <div class="flex-1 h-2 rounded-full" :class="passwordStrength >= 3 ? 'bg-green-500' : 'bg-gray-200'"></div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">Confirm New Password</label>
                    <input 
                        type="password"
                        x-model="formData.new_password_confirm"
                        @input="validateMatch"
                        class="w-full px-4 py-3 border-2 rounded-lg focus:border-neon focus:outline-none transition"
                        :class="{ 'border-red-500': matchError, 'border-gray-300': !matchError }"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                    >
                    <p x-show="matchError" x-text="matchError" class="text-red-500 text-sm mt-1"></p>
                </div>
                
                <button 
                    type="submit"
                    :disabled="loading"
                    class="w-full py-3 bg-neon text-white rounded-lg font-semibold hover:bg-green-600 transition transform hover:scale-105 disabled:opacity-50">
                    <span x-show="!loading">Reset Password ‚úì</span>
                    <span x-show="loading">
                        <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function confirmForm() {
        return {
            token: '{{ token }}',
            formData: {
                new_password: '',
                new_password_confirm: ''
            },
            error: '',
            passwordError: '',
            matchError: '',
            showPassword: false,
            loading: false,
            success: false,
            passwordStrength: 0,
            
            validatePassword() {
                const pass = this.formData.new_password;
                this.passwordStrength = 0;
                
                if (pass.length < 8) {
                    this.passwordError = 'Password must be at least 8 characters';
                    return;
                }
                this.passwordStrength = 1;
                
                if (!/[A-Z]/.test(pass) || !/[a-z]/.test(pass)) {
                    this.passwordError = 'Include uppercase and lowercase letters';
                    return;
                }
                this.passwordStrength = 2;
                
                if (!/[0-9]/.test(pass)) {
                    this.passwordError = 'Include at least one number';
                    return;
                }
                this.passwordStrength = 3;
                
                this.passwordError = '';
            },
            
            validateMatch() {
                if (this.formData.new_password !== this.formData.new_password_confirm) {
                    this.matchError = 'Passwords do not match';
                } else {
                    this.matchError = '';
                }
            },
            
            async submitConfirm() {
                this.error = '';
                this.loading = true;
                
                this.validatePassword();
                this.validateMatch();
                
                if (this.passwordError || this.matchError) {
                    this.loading = false;
                    return;
                }
                
                try {
                    const response = await fetch('/api/auth/password-reset/confirm', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: this.token,
                            ...this.formData
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.success = true;
                        gsap.fromTo('.glass', 
                            { scale: 1 }, 
                            { scale: 1.05, duration: 0.3, yoyo: true, repeat: 1 }
                        );
                    } else {
                        this.error = data.detail || 'Invalid or expired reset link';
                    }
                } catch (err) {
                    this.error = 'Failed to reset password. Please try again.';
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{% endblock %}
