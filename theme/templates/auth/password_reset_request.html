{% extends 'base.html' %}

{% block title %}Reset Password - FarmBasket{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 bg-gradient-to-br from-green-50 to-white">
    <div class="max-w-md w-full">

        <div class="glass rounded-2xl shadow-2xl p-8" x-data="otpResetFlow()">

            <!-- Icon -->
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üîê</div>
                <h2 class="font-display text-3xl font-bold mb-2">Forgot Password?</h2>
                <p class="text-gray-600" x-text="stepMessage"></p>
            </div>

            <!-- Messages -->
            <div x-show="successMessage" x-transition
                class="mb-6 p-4 bg-green-100 text-green-700 rounded-lg flex items-center gap-2">
                <span>‚úÖ</span> <span x-text="successMessage"></span>
            </div>

            <div x-show="errorMessage" x-transition
                class="mb-6 p-4 bg-red-100 text-red-700 rounded-lg flex items-center gap-2">
                <span>‚ö†Ô∏è</span> <span x-text="errorMessage"></span>
            </div>

            <!-- PHASE 1: Identification (Email & OTP) -->
            <form @submit.prevent="handlePhase1" novalidate x-show="phase === 1"
                x-transition:enter="transition ease-out duration-300">

                <!-- Email Field -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">Email Address</label>
                    <input type="email" x-model="email" @input="validateEmail"
                        class="w-full px-4 py-3 border-2 rounded-lg focus:border-neon focus:outline-none transition"
                        :class="{'border-red-500': emailError, 'border-gray-300': !emailError}"
                        placeholder="you@example.com">
                    <p x-show="emailError" x-text="emailError" class="text-red-500 text-sm mt-1"></p>
                </div>

                <!-- OTP Field (Always visible) -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">One-Time Password (OTP)</label>
                    <input type="text" x-model="otp" @input="checkOtpInput"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none transition"
                        placeholder="Have valid OTP?" maxlength="6">
                </div>

                <!-- Dynamic Button -->
                <button type="submit" :disabled="isSubmitDisabled"
                    class="w-full py-3 text-white rounded-lg font-semibold transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex justify-center items-center gap-2"
                    :class="otp.length > 0 ? 'bg-neon hover:bg-green-800' : 'bg-neon hover:bg-green-600'">

                    <span x-show="!loading" x-text="otp.length > 0 ? 'Verify OTP üîì' : 'Send OTP üìß'"></span>
                    <span x-show="loading"
                        class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span>
                </button>
            </form>

            <!-- PHASE 2: Reset Password (Hidden until Verified) -->
            <form @submit.prevent="resetPassword" novalidate x-show="phase === 2"
                x-transition:enter="transition ease-out duration-300">

                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">New Password</label>
                    <div class="relative">
                        <input :type="showPassword ? 'text' : 'password'" x-model="newPassword"
                            @input="validatePassword"
                            class="w-full px-4 py-3 border-2 rounded-lg focus:border-neon focus:outline-none transition"
                            :class="{'border-red-500': passwordError, 'border-gray-300': !passwordError}"
                            placeholder="Min 8 chars, Upper, Lower, Symbol">
                        <button type="button" @click="showPassword = !showPassword"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <span x-show="!showPassword">üëÅÔ∏è</span><span x-show="showPassword">üëÅÔ∏è‚Äçüó®Ô∏è</span>
                        </button>
                    </div>
                    <!-- Password Strength Meter -->
                    <div class="flex gap-1 mt-2 h-1">
                        <div class="flex-1 rounded-full transition-colors duration-300"
                            :class="passwordStrength > 0 ? 'bg-red-500' : 'bg-gray-200'"></div>
                        <div class="flex-1 rounded-full transition-colors duration-300"
                            :class="passwordStrength > 1 ? 'bg-orange-500' : 'bg-gray-200'"></div>
                        <div class="flex-1 rounded-full transition-colors duration-300"
                            :class="passwordStrength > 2 ? 'bg-yellow-500' : 'bg-gray-200'"></div>
                        <div class="flex-1 rounded-full transition-colors duration-300"
                            :class="passwordStrength > 3 ? 'bg-green-500' : 'bg-gray-200'"></div>
                    </div>
                    <p x-show="passwordError" x-text="passwordError" class="text-xs text-red-500 mt-1"></p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">Confirm Password</label>
                    <input type="password" x-model="confirmPassword" @input="validateMatch"
                        class="w-full px-4 py-3 border-2 rounded-lg focus:border-neon focus:outline-none transition"
                        :class="{'border-red-500': confirmError, 'border-gray-300': !confirmError}"
                        placeholder="Confirm New Password">
                    <p x-show="confirmError" x-text="confirmError" class="text-xs text-red-500 mt-1"></p>
                </div>

                <button type="submit" :disabled="isSubmitDisabled"
                    class="w-full py-3 bg-neon text-white rounded-lg font-semibold hover:bg-green-600 transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex justify-center items-center gap-2">
                    <span x-show="!loading">Set New Password üíæ</span>
                    <span x-show="loading"
                        class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span>
                </button>
            </form>

            <div class="text-center mt-6">
                <a href="{% url 'accounts:login' %}" class="text-neon hover:underline">‚Üê Back to Login</a>
            </div>
        </div>
    </div>
</div>

<script>
    function otpResetFlow() {
        return {
            phase: 1, // 1: Identify, 2: Reset
            email: '',
            otp: '',
            newPassword: '',
            confirmPassword: '',
            showPassword: false,

            loading: false,
            errorMessage: '',
            successMessage: '',

            // Validation
            emailError: '',
            passwordStrength: 0,
            passwordError: '',
            confirmError: '',

            get stepMessage() {
                if (this.phase === 1) return "Enter your email to get a code, or verify an existing one.";
                return "Create a strong new password to secure your account.";
            },

            get isSubmitDisabled() {
                // Always block if loading
                if (this.loading) return true;

                if (this.phase === 1) {
                    // Validating Step 1
                    if (!this.email) return true; // Block if empty
                    if (this.emailError) return true; // Block if invalid format
                    // OTP is optional for "Send", mandatory for "Verify" (but handled by click logic)
                    return false;
                }

                // Phase 2
                return this.passwordError || this.confirmError || !this.newPassword || !this.confirmPassword;
            },

            checkOtpInput() {
                // Just triggers reactivity for button class/text
            },

            validateEmail(strict = false) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                // If checking strictly (on submit) and empty, it's an error
                if (strict && !this.email) {
                    this.emailError = 'Please enter your email address';
                    return;
                }

                if (!this.email) {
                    this.emailError = ''; // Normal input: clear error if empty
                    return;
                }

                if (!emailRegex.test(this.email)) {
                    this.emailError = 'Please enter a valid email';
                } else {
                    this.emailError = '';
                }
            },

            async handlePhase1() {
                // Strict validation on trigger
                this.validateEmail(true);

                // Double check both the error state AND the raw value
                if (this.emailError || !this.email) {
                    // Ensure error is visible if it wasn't valid
                    if (!this.emailError) this.emailError = 'Please enter your email address';
                    return;
                }

                // Guard against blocked UI
                if (this.isSubmitDisabled) return;

                if (this.otp.length > 0) {
                    await this.verifyOtp();
                } else {
                    await this.sendOtp();
                }
            },

            async sendOtp() {
                this.loading = true;
                this.errorMessage = '';
                this.successMessage = '';

                try {
                    const res = await fetch('/api/otp/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.email, type: 'forgotPwd' })
                    });
                    const data = await res.json();

                    if (res.ok) {
                        this.successMessage = data.message;
                    } else {
                        if (res.status === 404) {
                            this.errorMessage = data.detail || "You are not organic, wanna join our journey?";
                        } else {
                            this.errorMessage = data.detail || 'Failed to send OTP.';
                        }
                    }
                } catch (e) {
                    this.errorMessage = "Connection error. Please try again.";
                } finally {
                    this.loading = false;
                }
            },

            async verifyOtp() {
                // Redundant safety check
                if (!this.email) {
                    this.emailError = 'Please enter your email address';
                    return;
                }

                this.loading = true;
                this.errorMessage = '';

                try {
                    const res = await fetch('/api/otp/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.email, otp: this.otp, type: 'forgotPwd' })
                    });
                    const data = await res.json();

                    if (res.ok) {
                        this.phase = 2; // Move to reset phase
                        this.successMessage = "OTP Verified! Set your new password.";
                        setTimeout(() => this.successMessage = '', 3000);
                    } else {
                        this.errorMessage = data.detail || 'Invalid OTP.';
                    }
                } catch (e) {
                    this.errorMessage = "Verification failed. Please try again.";
                } finally {
                    this.loading = false;
                }
            },

            validatePassword() {
                this.passwordError = '';
                const p = this.newPassword;
                let s = 0;
                if (p.length >= 8) s++;
                if (/[A-Z]/.test(p)) s++;
                if (/[0-9]/.test(p)) s++;
                if (/[^A-Za-z0-9]/.test(p)) s++;

                this.passwordStrength = s;

                if (s < 4) {
                    this.passwordError = "Weak Password. Use 8+ chars, Upper, Number & Symbol.";
                }

                if (this.confirmPassword) this.validateMatch();
            },

            validateMatch() {
                this.confirmError = '';
                if (this.newPassword !== this.confirmPassword) {
                    this.confirmError = "Passwords do not match.";
                }
            },

            async resetPassword() {
                this.validatePassword();
                this.validateMatch();
                if (this.isSubmitDisabled) return;

                this.loading = true;
                this.errorMessage = '';

                try {
                    const res = await fetch('/api/otp/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.email, otp: this.otp, new_password: this.newPassword })
                    });
                    const data = await res.json();

                    if (res.ok) {
                        this.successMessage = "Password Reset Successfully! Redirecting...";
                        setTimeout(() => {
                            window.location.href = "{% url 'accounts:login' %}";
                        }, 2000);
                    } else {
                        this.errorMessage = data.detail || 'Reset failed.';
                    }
                } catch (e) {
                    this.errorMessage = "Reset failed. Please try again.";
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{% endblock %}