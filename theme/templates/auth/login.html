{% extends 'base.html' %}

{% block title %}Login - FarmBasket{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 bg-gradient-to-br from-green-50 to-white">
    <div class="max-w-md w-full">

        <!-- Card Container -->
        <!-- Added overflow-hidden relative for the sliding mechanism -->
        <div class="glass rounded-2xl shadow-2xl p-8 overflow-hidden relative" x-data="loginForm()">

            <!-- Header -->
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üß∫</div>
                <h2 class="font-display text-3xl font-bold mb-2 transition-opacity duration-300"
                    x-text="showPinless ? 'Pinless Login' : 'Welcome Back!'"></h2>
                <p class="text-gray-600 transition-opacity duration-300"
                    x-text="showPinless ? 'Login instantly with a One-Time Password' : 'Login to continue shopping organic'">
                </p>
            </div>

            <!-- Success Message -->
            <div x-show="successMessage" x-transition
                class="mb-6 p-4 bg-green-100 text-green-700 rounded-lg flex items-center gap-2">
                <span>‚úÖ</span> <span x-text="successMessage"></span>
            </div>

            <!-- Error Alert -->
            <div x-show="error" x-transition class="mb-6 p-4 bg-red-100 text-red-700 rounded-lg">
                <span x-text="error"></span>
            </div>

            <!-- SLIDER CONTAINER -->
            <!-- 
                 Robust Carousel Logic:
                 - Wrapper: overflow-hidden w-full (Constrains view to 1 slide width)
                 - Train: flex (Holds slides side-by-side)
                 - Slides: w-full flex-shrink-0 (Forces each slide to take full Wrapper width)
                 - Translate: -translate-x-full moves exactly one slide width (100%)
            -->
            <div class="overflow-hidden relative w-full">
                <div class="flex transition-transform duration-500 ease-in-out"
                    :class="showPinless ? '-translate-x-full' : 'translate-x-0'">

                    <!-- SECTION 1: PASSWORD LOGIN (Slide 1) -->
                    <div class="w-full flex-shrink-0 px-1">
                        <form @submit.prevent="submitPasswordLogin" novalidate>
                            <!-- Email -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Email</label>
                                <!-- Using top-level 'email' model -->
                                <input type="email" x-model="email"
                                    class="w-full px-4 py-3 border-2 rounded-lg focus:border-neon focus:outline-none transition"
                                    :class="{ 'border-red-500': emailError, 'border-gray-300': !emailError }"
                                    placeholder="you@example.com">
                                <p x-show="emailError" x-text="emailError" class="text-red-500 text-sm mt-1"></p>
                            </div>

                            <!-- Password -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Password</label>
                                <div class="relative">
                                    <input :type="showPassToggle ? 'text' : 'password'" x-model="password"
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none transition"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                                    <button type="button" @click="showPassToggle = !showPassToggle"
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        <span x-show="!showPassToggle">üëÅÔ∏è</span>
                                        <span x-show="showPassToggle">üëÅÔ∏è‚Äçüó®Ô∏è</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Forgot -->
                            <div class="flex items-center justify-end mb-6">
                                <a href="{% url 'accounts:password_reset_request' %}"
                                    class="text-sm text-neon hover:underline">Forgot password?</a>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" :disabled="isPasswordDisabled"
                                class="w-full py-3 bg-neon text-white rounded-lg font-semibold hover:bg-green-600 transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                                <span x-show="!loading">Login üöÄ</span>
                                <span x-show="loading"
                                    class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span>
                            </button>
                        </form>
                    </div>

                    <!-- SECTION 2: PINLESS LOGIN (Slide 2) -->
                    <div class="w-full flex-shrink-0 px-1">
                        <form @submit.prevent="handlePinlessSubmit" novalidate>
                            <!-- Email (Reused Model: 'email') -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-2">Email Address</label>
                                <input type="email" x-model="email"
                                    class="w-full px-4 py-3 border-2 rounded-lg focus:border-neon focus:outline-none transition"
                                    :class="{ 'border-red-500': emailError, 'border-gray-300': !emailError }"
                                    placeholder="you@example.com">
                                <p x-show="emailError" x-text="emailError" class="text-red-500 text-sm mt-1"></p>
                            </div>

                            <!-- OTP Field -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">One-Time Password (OTP)</label>
                                <input type="text" x-model="otp"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-neon focus:outline-none transition "
                                    placeholder="Have valid OTP?" maxlength="6">
                                <p class="text-xs text-gray-500 mt-2">Enter email and click Send OTP to receive code.
                                </p>
                            </div>

                            <!-- Submit Button (Replica of Forgot Password Logic) -->
                            <button type="submit" :disabled="isPinlessDisabled"
                                class="w-full py-3 text-white rounded-lg font-semibold transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2"
                                :class="otp.length > 0 ? 'bg-neon hover:bg-green-700' : 'bg-neon hover:bg-green-600'">

                                <span x-show="!loading" x-text="otp.length > 0 ? 'Login üöÄ' : 'Send OTP üìß'"></span>
                                <span x-show="loading"
                                    class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span>
                            </button>
                        </form>
                    </div>

                </div>
            </div>

            <!-- Toggle Switch -->
            <div class="mt-6 text-center">
                <button @click="toggleMode" type="button"
                    class="text-sm font-semibold text-gray-500 hover:text-neon transition flex items-center justify-center gap-2 w-full">
                    <span x-text="showPinless ? '‚Üê Back to Password Login' : 'Try Pinless Login ‚Üí'"></span>
                </button>
            </div>

            <!-- OR Divider -->
            <div class="flex items-center my-6">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="mx-2 text-gray-500 text-sm">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <!-- Google Sign-In -->
            <div class="flex justify-center">
                <a href="/api/auth/google/login"
                    class="flex items-center gap-3 px-6 py-3 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition shadow-sm font-semibold text-gray-700 w-full justify-center">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                    Continue with Google
                </a>
            </div>

            <p class="text-center mt-6 text-gray-600">
                Don't have an account?
                <a href="{% url 'accounts:register' %}" class="text-neon font-semibold hover:underline">Sign up</a>
            </p>
        </div>
    </div>
</div>


<script>
    // ‚úÖ PRESERVED: Check if already logged in logic
    window.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('access_token');
        if (token) {
            // Show notification if available
            if (window.showNotification) {
                window.showNotification({
                    type: 'info',
                    title: 'Already Logged In',
                    message: 'You are already logged in. Redirecting to your profile...',
                    icon: 'üë§'
                });
            }

            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = '/profile/';
            }, 1000);
        }
    });

    function loginForm() {
        return {
            showPinless: false,

            // Flattened models
            email: '',
            password: '',
            otp: '',

            error: '',
            emailError: '',
            successMessage: '',
            showPassToggle: false,
            loading: false,

            // Exact Replica of Password Reset Logic
            get isPinlessDisabled() {
                if (this.loading) return true;
                if (!this.email) return true; // Block if empty
                if (this.emailError) return true; // Block if error
                return false;
            },

            // ‚úÖ Added for standard login
            get isPasswordDisabled() {
                if (this.loading) return true;
                if (!this.email) return true;
                if (this.emailError) return true;
                if (!this.password) return true;
                return false;
            },

            init() {
                // Check errors from URL
                const params = new URLSearchParams(window.location.search);
                if (params.has('error')) {
                    this.error = params.get('error');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                // ‚úÖ Fix: Watch email for changes to handle validation reliably
                this.$watch('email', (value) => {
                    this.validateEmail(value);
                });
            },

            toggleMode() {
                this.error = '';
                this.successMessage = '';
                this.showPinless = !this.showPinless;
            },

            validateEmail(value, strict = false) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const emailToCheck = value || this.email; // Use passed value or current model

                if (strict && !emailToCheck) {
                    this.emailError = 'Please enter valid email';
                    return;
                }

                if (!emailToCheck) {
                    this.emailError = '';
                    return;
                }

                if (!emailRegex.test(emailToCheck)) {
                    this.emailError = 'Please enter a valid email';
                } else {
                    this.emailError = '';
                }
            },

            async submitPasswordLogin() {
                this.error = '';
                this.successMessage = '';
                this.loading = true;

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: this.email,
                            password: this.password
                        })
                    });

                    const data = await response.json();
                    this.handleLoginResponse(response, data);

                } catch (err) {
                    console.error('Login error:', err);
                    this.error = 'Something went wrong. Please try again.';
                    this.loading = false;
                }
            },

            async handlePinlessSubmit() {
                // Unified logic based on OTP input length
                if (this.otp.length > 0) {
                    await this.verifyPinlessLogin();
                } else {
                    await this.sendPinlessOtp();
                }
            },

            async sendPinlessOtp() {
                this.validateEmail(true); // Strict check
                if (this.emailError || !this.email) {
                    return;
                }

                this.loading = true;
                this.error = '';
                this.successMessage = '';

                try {
                    const res = await fetch('/api/otp/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.email, type: 'bypassPwd' })
                    });
                    const data = await res.json();

                    if (res.ok) {
                        this.successMessage = data.message || 'OTP sent successfully! Check your inbox.';
                        // Focus OTP field
                        setTimeout(() => document.querySelector('input[placeholder="Enter Code"]')?.focus(), 100);
                        this.error = '';
                    } else {
                        this.error = data.detail || 'Failed to send OTP.';
                    }
                } catch (e) {
                    this.error = "Connection error.";
                } finally {
                    this.loading = false;
                }
            },

            async verifyPinlessLogin() {
                this.validateEmail(true);
                if (this.emailError) return;

                this.loading = true;
                this.error = '';

                try {
                    const res = await fetch('/api/otp/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: this.email,
                            otp: this.otp,
                            type: 'bypassPwd'
                        })
                    });
                    const data = await res.json();
                    this.handleLoginResponse(res, data);

                } catch (e) {
                    this.error = "Verification failed.";
                    this.loading = false;
                }
            },

            handleLoginResponse(response, data) {
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);

                    gsap.to('.glass', {
                        scale: 1.05,
                        duration: 0.3,
                        yoyo: true,
                        repeat: 1,
                        onComplete: () => {
                            if (data.is_superuser) {
                                window.location.href = '/admin/';
                            } else {
                                window.location.href = '/profile/';
                            }
                        }
                    });
                } else {
                    // Normalize Error Handling
                    if (Array.isArray(data.detail) && data.detail.length > 0) {
                        this.error = data.detail[0].msg || 'Validation error';
                    } else {
                        this.error = data.detail || data.message || 'Login failed';
                    }

                    this.loading = false;
                    gsap.fromTo('.glass',
                        { x: -10 },
                        { x: 10, duration: 0.1, repeat: 5, yoyo: true }
                    );
                }
            }
        }
    }
</script>
{% endblock %}