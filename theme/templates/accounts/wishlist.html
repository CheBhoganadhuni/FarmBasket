{% extends 'base.html' %}

{% block title %}My Wishlist - FarmBasket{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-white py-12 px-4" x-data="wishlistPage()">
    <div class="container mx-auto max-w-7xl">

        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="font-display text-4xl font-bold mb-2">üíö My Wishlist</h1>
                <p class="text-gray-600">Your favorite organic products</p>
            </div>
            <a href="/products/"
                class="px-6 py-3 bg-neon text-white rounded-lg hover:bg-green-600 transition font-semibold">
                Continue Shopping
            </a>
        </div>

        <!-- Loading -->
        <template x-if="loading">
            <div class="grid md:grid-cols-4 gap-6">
                <template x-for="i in 4">
                    <div class="skeleton h-80 rounded-xl"></div>
                </template>
            </div>
        </template>

        <!-- Wishlist Grid -->
        <template x-if="!loading && items.length > 0">
            <div class="grid md:grid-cols-4 gap-6">
                <template x-for="product in items" :key="product.id">
                    <div
                        class="glass rounded-xl overflow-hidden hover:shadow-2xl transition transform hover:-translate-y-2 group relative">

                        <!-- Remove Button -->
                        <button @click="removeFromWishlist(product.id)"
                            :disabled="loadingRemoveIds.includes(product.id)"
                            class="absolute top-2 right-2 z-10 p-2 bg-white rounded-full text-red-500 hover:bg-red-50 shadow-md transition disabled:opacity-50">
                            <span x-show="!loadingRemoveIds.includes(product.id)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </span>
                            <span x-show="loadingRemoveIds.includes(product.id)" class="animate-spin text-sm">‚è≥</span>
                        </button>

                        <!-- Image -->
                        <a :href="`/products/${product.slug}/`" class="block h-48 overflow-hidden relative">
                            <img :src="product.featured_image || 'https://via.placeholder.com/400'" :alt="product.name"
                                class="w-full h-full object-cover group-hover:scale-110 transition duration-500">

                            <!-- Badges -->
                            <div class="absolute top-2 left-2 flex gap-1">
                                <span x-show="product.is_organic_certified"
                                    class="px-2 py-1 bg-green-500 text-white text-xs rounded-full font-bold">Organic</span>
                            </div>
                        </a>

                        <!-- Content -->
                        <div class="p-4">
                            <div class="text-sm text-gray-600 mb-1">
                                <span x-text="product.category_icon"></span>
                                <span x-text="product.category_name"></span>
                            </div>

                            <a :href="`/products/${product.slug}/`">
                                <h3 class="font-bold text-lg mb-1 truncate" x-text="product.name"></h3>
                            </a>

                            <!-- Rating -->
                            <div class="flex items-center gap-1 mb-2 text-yellow-500 text-sm">
                                <template x-for="i in 5">
                                    <span x-text="i <= Math.round(product.average_rating) ? '‚≠ê' : '‚òÜ'"></span>
                                </template>
                                <span class="text-gray-400 ml-1">(<span x-text="product.review_count"></span>)</span>
                            </div>

                            <div class="flex items-center justify-between mb-4">
                                <span class="text-xl font-bold text-neon">‚Çπ<span x-text="product.price"></span></span>
                                <span x-show="!product.in_stock" class="text-xs text-red-500 font-bold">Out of
                                    Stock</span>
                                <span x-show="product.in_stock" class="text-xs text-green-600 font-bold">‚úì In
                                    Stock</span>
                            </div>

                            <!-- Add to Cart (Replaces View Details) -->
                            <button @click="addToCart(product.id)"
                                :disabled="!product.in_stock || loadingCartIds.includes(product.id)"
                                class="w-full py-2 bg-neon/20 hover:bg-neon hover:text-white text-neon rounded-lg transition font-semibold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!loadingCartIds.includes(product.id)">üõí Add to Cart</span>
                                <span x-show="loadingCartIds.includes(product.id)" class="animate-spin">‚è≥</span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="!loading && items.length === 0">
            <div class="text-center py-20">
                <div class="text-6xl mb-4">üíî</div>
                <h3 class="text-2xl font-bold mb-2">Your wishlist is empty</h3>
                <p class="text-gray-600 mb-6">Find something you love and save it here!</p>
                <a href="/products/"
                    class="inline-block px-6 py-3 bg-neon text-white rounded-lg hover:bg-green-600 transition font-semibold">
                    Browse Products
                </a>
            </div>
        </template>

    </div>
</div>

<script>
    function wishlistPage() {
        return {
            items: [],
            loading: true,
            // Array based loaders
            loadingRemoveIds: [],
            loadingCartIds: [],

            async init() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/auth/login/?next=/wishlist/';
                    return;
                }

                // Animate entrance - Re-added as user liked it generally, just ensuring safeness
                if (typeof gsap !== 'undefined') {
                    gsap.from('.glass', {
                        y: 20,
                        opacity: 0,
                        duration: 0.5,
                        stagger: 0.1
                    });
                }

                await this.fetchWishlist();
            },

            async fetchWishlist() {
                const token = localStorage.getItem('access_token');
                try {
                    const response = await fetch('/api/catalog/wishlist', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        this.items = await response.json();
                    }
                } catch (err) {
                    console.error('Failed to fetch wishlist', err);
                } finally {
                    this.loading = false;
                }
            },

            removeFromWishlist(productId) {
                window.showNotification({
                    type: 'delete',
                    title: 'Remove from Wishlist?',
                    message: 'Are you sure you want to remove this item?',
                    showCancel: true,
                    confirmText: 'Remove',
                    onConfirm: () => {
                        this.doRemoveFromWishlist(productId);
                    }
                });
            },

            async doRemoveFromWishlist(productId) {
                const token = localStorage.getItem('access_token');
                if (this.loadingRemoveIds.includes(productId)) return;
                this.loadingRemoveIds.push(productId);

                try {
                    const response = await fetch(`/api/catalog/wishlist/remove/${productId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        // Remove locally
                        this.items = this.items.filter(p => p.id !== productId);
                        window.showNotification({
                            type: 'success',
                            message: 'Removed from wishlist'
                        });
                    }
                } catch (err) {
                    console.error('Failed to remove', err);
                } finally {
                    this.loadingRemoveIds = this.loadingRemoveIds.filter(id => id !== productId);
                }
            },

            async addToCart(productId) {
                const token = localStorage.getItem('access_token');
                if (this.loadingCartIds.includes(productId)) return;
                this.loadingCartIds.push(productId);

                try {
                    const response = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ product_id: productId, quantity: 1 })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            window.dispatchEvent(new CustomEvent('cart-updated', {
                                detail: { count: data.cart_count }
                            }));
                            window.showNotification({
                                type: 'cart',
                                title: 'Added to Cart! üéâ',
                                message: `${data.message}<br><br>Ready to checkout?`,
                                confirmText: 'View Cart',
                                showCancel: true,
                                onConfirm: () => {
                                    window.location.href = '/cart/';
                                }
                            });
                        }
                    }
                } catch (err) {
                    console.error('Failed to add to cart', err);
                } finally {
                    this.loadingCartIds = this.loadingCartIds.filter(id => id !== productId);
                }
            }
        }
    }
</script>
{% endblock %}