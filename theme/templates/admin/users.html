{% extends 'admin/base_admin.html' %}

{% block title %}Users{% endblock %}
{% block page_title %}User Management{% endblock %}
{% block page_subtitle %}View and manage customer accounts{% endblock %}

{% block content %}
<div x-data="usersManager()" x-init="init()" class="space-y-6">

    <!-- Toolbar -->
    <div class="admin-card p-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div class="flex-1">
            <!-- Search -->
            <div class="relative">
                <input type="text" x-model="searchQuery" @input.debounce.500ms="loadUsers()"
                    placeholder="Search by name or email..." class="admin-input pl-10">
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        </div>

        <div class="text-sm text-gray-400">
            Total: <span class="font-bold text-white" x-text="users.length"></span> users
        </div>
    </div>

    <!-- Loading State -->
    <template x-if="loading">
        <div class="flex items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
    </template>

    <!-- Users Grid -->
    <template x-if="!loading && users.length > 0">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="user in users" :key="user.id">
                <div class="admin-card p-6">
                    <!-- User Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-4">
                            <!-- Avatar -->
                            <div
                                class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">
                                <span
                                    x-text="user.first_name ? user.first_name.charAt(0) : user.email.charAt(0)"></span>
                            </div>

                            <!-- User Info -->
                            <div>
                                <h3 class="font-bold text-lg" x-text="user.full_name || 'No Name'"></h3>
                                <p class="text-sm text-gray-400" x-text="user.email"></p>
                            </div>
                        </div>

                        <!-- Status Badge -->
                        <span class="badge text-xs" :class="user.is_active ? 'badge-success' : 'badge-danger'"
                            x-text="user.is_active ? 'Active' : 'Inactive'"></span>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-3 mb-4 py-4 border-y border-gray-700">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-500" x-text="user.orders_count"></p>
                            <p class="text-xs text-gray-500">Orders</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-500">‚Çπ<span x-text="user.total_spent"></span></p>
                            <p class="text-xs text-gray-500">Spent</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-yellow-500" x-text="user.xp_points"></p>
                            <p class="text-xs text-gray-500">XP</p>
                        </div>
                    </div>

                    <!-- Loyalty Tier -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">
                                <template x-if="user.loyalty_tier === 'SEEDLING'">üå±</template>
                                <template x-if="user.loyalty_tier === 'SPROUT'">üåø</template>
                                <template x-if="user.loyalty_tier === 'TREE'">üå≥</template>
                                <template x-if="user.loyalty_tier === 'FOREST'">üèÜ</template>
                            </span>
                            <span class="text-sm font-semibold" x-text="user.loyalty_tier"></span>
                        </div>
                        <span class="badge badge-info text-xs" x-show="user.is_staff">Admin</span>
                    </div>
                    <!-- Actions -->
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-700">
                        <div class="flex flex-col">
                            <span
                                class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1">Status</span>
                            <span class="text-sm font-bold" :class="user.is_active ? 'text-green-500' : 'text-red-500'"
                                x-text="user.is_active ? 'Active' : 'Inactive'"></span>
                        </div>

                        <!-- Toggle Button -->
                        <button @click="toggleUserActive(user)" :disabled="user.processing"
                            class="px-4 py-2 rounded-lg text-xs font-bold shadow-sm transition-all flex items-center gap-2 text-white transform hover:scale-105 active:scale-95"
                            :class="user.is_active 
                                    ? 'bg-red-500 hover:bg-red-600 shadow-red-500/30' 
                                    : 'bg-green-500 hover:bg-green-600 shadow-green-500/30'">
                            <span x-show="!user.processing"
                                x-text="user.is_active ? 'Deactivate User' : 'Activate User'"></span>
                            <span x-show="user.processing" class="flex items-center gap-2">
                                <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span>Processing...</span>
                            </span>
                        </button>
                    </div>

                    <!-- Delete Button (Restored) -->
                    <div class="mt-3 pt-3 border-t border-gray-800 flex justify-end">
                        <button @click="confirmDeleteUser(user.id)"
                            class="text-xs text-red-500 hover:text-red-400 hover:underline flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                            Delete Permanently
                        </button>
                    </div>

                    <!-- Dates -->
                    <div class="space-y-2 text-xs text-gray-500">
                        <div class="flex items-center justify-between">
                            <span>Joined:</span>
                            <span x-text="new Date(user.date_joined).toLocaleDateString()"></span>
                        </div>
                        <div class="flex items-center justify-between" x-show="user.last_login">
                            <span>Last Login:</span>
                            <span
                                x-text="user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <!-- Empty State -->
    <template x-if="!loading && users.length === 0">
        <div class="admin-card p-20 text-center">
            <div class="text-6xl mb-4">üë•</div>
            <h3 class="text-2xl font-bold mb-2">No users found</h3>
            <p class="text-gray-400">User accounts will appear here</p>
        </div>
    </template>
</div>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function usersManager() {
        return {
            loading: true,
            users: [],
            searchQuery: '',

            async init() {
                await this.loadUsers();
            },

            confirmDeleteUser(userId) {
                if (confirm('‚ö†Ô∏è DANGER: Are you sure you want to PERMANENTLY delete this user?\n\nThis will remove all their data including orders and cannot be undone.')) {
                    this.deleteUser(userId);
                }
            },

            async deleteUser(userId) {
                const token = localStorage.getItem('access_token');
                const csrftoken = getCookie('csrftoken');
                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'X-CSRFToken': csrftoken
                        }
                    });

                    if (response.ok) {
                        alert('User deleted successfully.');
                        this.loadUsers();
                    } else {
                        const data = await response.json();
                        alert(data.message || 'Failed to delete user.');
                    }
                } catch (err) {
                    console.error('Failed to delete user', err);
                    alert('Error deleting user.');
                }
            },

            async toggleUserActive(user) {
                // Optimistic Update & No Confirm (as per request)
                const previousState = user.is_active;

                // Flip state immediately
                user.is_active = !user.is_active;
                user.processing = true;

                const token = localStorage.getItem('access_token');
                const csrftoken = getCookie('csrftoken');

                try {
                    const response = await fetch(`/api/admin/users/${user.id}/toggle-active`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'X-CSRFToken': csrftoken
                        }
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        alert(data.message || 'Failed to update status.');
                        user.is_active = previousState; // Revert on failure
                    }
                } catch (err) {
                    console.error('Failed to update status', err);
                    alert('Error updating status.');
                    user.is_active = previousState; // Revert on error
                } finally {
                    user.processing = false;
                }
            },

            async loadUsers() {
                this.loading = true;
                const token = localStorage.getItem('access_token');

                const params = new URLSearchParams();
                if (this.searchQuery) params.append('search', this.searchQuery);

                try {
                    const response = await fetch(`/api/admin/users?${params}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Initialize processing state for reactivity
                        this.users = data.users.map(u => ({ ...u, processing: false }));
                    }
                } catch (err) {
                    console.error('Failed to load users', err);
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{% endblock %}