{% extends 'admin/base_admin.html' %}

{% block title %}Products{% endblock %}
{% block page_title %}Product Management{% endblock %}
{% block page_subtitle %}Manage your product catalog{% endblock %}

{% block content %}
<div x-data="productsManager()" x-init="init()" class="space-y-6">
    
<!-- Toolbar -->
<div class="admin-card p-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
    <div class="flex-1 flex flex-col md:flex-row gap-3 w-full">
        <!-- Search -->
        <div class="relative flex-grow min-w-0">
            <input 
                type="text" 
                x-model="filters.search"
                @input.debounce.500ms="loadProducts()"
                placeholder="Search products..." 
                class="admin-input pl-10 w-full"
                style="min-width: 0;"
            >
            <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </div>

        <!-- Category Filter -->
        <select x-model="filters.category" @change="loadProducts()" class="admin-input w-40 shrink-0">
            <option value="">All Categories</option>
            <template x-for="category in categories" :key="category.id">
                <option :value="category.id" x-text="category.name"></option>
            </template>
        </select>

        <!-- Stock Filter -->
        <select x-model="filters.stock_quantity" @change="loadProducts()" class="admin-input w-40 shrink-0">
            <option value="">All Stock</option>
            <option value="low">Low Stock</option>
            <option value="out">Out of Stock</option>
        </select>
    </div>
    
    <!-- Add Product Button -->
    <button @click="openAddModal()" class="admin-btn-primary flex items-center gap-2 whitespace-wrap">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Add
    </button>
</div>

    
    <!-- Loading State -->
    <template x-if="loading">
        <div class="flex items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
    </template>
    
    <!-- Products Grid -->
    <template x-if="!loading && products.length > 0">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <template x-for="product in products" :key="product.id">
                <div class="admin-card overflow-hidden group">
                    <!-- Product Image -->
                    <div class="relative aspect-square overflow-hidden bg-gray-900">
                        <img 
                            :src="product.featured_image || 'https://via.placeholder.com/400x400?text=No+Image'" 
                            :alt="product.name"
                            class="w-full h-full object-cover group-hover:scale-110 transition duration-300"
                        >
                        <div class="absolute top-2 right-2 flex gap-2">
                            <span 
                                class="badge text-xs"
                                :class="product.stock_quantity > 10 ? 'badge-success' : product.stock_quantity > 0 ? 'badge-warning' : 'badge-danger'"
                                x-text="product.stock_quantity > 0 ? `Stock: ${product.stock_quantity}` : 'Out of Stock'"
                            ></span>
                        </div>
                    </div>
                    
                    <!-- Product Info -->
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-1 truncate" x-text="product.name"></h3>
                        <p class="text-sm text-gray-400 mb-3 line-clamp-2" x-text="product.description"></p>
                        
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-2xl font-bold text-blue-500">‚Çπ<span x-text="product.price"></span></p>
                                <p class="text-xs text-gray-500" x-text="product.category_name"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Unit</p>
                                <p class="text-sm font-semibold" x-text="product.unit"></p>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex gap-2">
                            <button 
                                @click="openEditModal(product)" 
                                class="flex-1 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition text-sm font-semibold"
                            >
                                Edit
                            </button>
                            <button 
                                @click="deleteProduct(product)" 
                                class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </template>
    
    <!-- Empty State -->
    <template x-if="!loading && products.length === 0">
        <div class="admin-card p-20 text-center">
            <div class="text-6xl mb-4">üì¶</div>
            <h3 class="text-2xl font-bold mb-2">No products found</h3>
            <p class="text-gray-400 mb-6">Start by adding your first product</p>
            <button @click="openAddModal()" class="admin-btn-primary">Add Product</button>
        </div>
    </template>
    
    <!-- Add/Edit Product Modal -->
    <div 
        x-show="showModal" 
        x-transition
        class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto"
        @click.self="closeModal()"
    >
        <div class="admin-card w-full max-w-2xl max-h-[90vh] overflow-y-auto" @click.stop>
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold" x-text="editMode ? 'Edit Product' : 'Add New Product'"></h2>
                    <button @click="closeModal()" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form @submit.prevent="saveProduct()" class="space-y-4">
                    <!-- Product Name -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Product Name *</label>
                        <input type="text" x-model="formData.name" required class="admin-input" placeholder="Organic Tomatoes">
                    </div>
                    
                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Description *</label>
                        <textarea x-model="formData.description" required rows="3" class="admin-input" placeholder="Fresh organic tomatoes from local farms"></textarea>
                    </div>
                    
                    <!-- Category & Unit -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Category *</label>
                            <select x-model="formData.category" required class="admin-input">
                                <option value="">Select category</option>
                                <template x-for="category in categories" :key="category.id">
                                    <option :value="category.id" x-text="category.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Unit *</label>
                            <select x-model="formData.unit" required class="admin-input">
                                <option value="kg">Kilogram (kg)</option>
                                <option value="g">Gram (g)</option>
                                <option value="L">Liter (L)</option>
                                <option value="ml">Milliliter (ml)</option>
                                <option value="piece">Piece</option>
                                <option value="dozen">Dozen</option>
                                <option value="bunch">Bunch</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Price & Stock -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Price (‚Çπ) *</label>
                            <input type="number" x-model="formData.price" required step="0.01" min="0" class="admin-input" placeholder="99.00">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Stock Quantity *</label>
                            <input type="number" x-model="formData.stock_quantity" required min="0" class="admin-input" placeholder="100">
                        </div>
                    </div>
                    
                    <!-- Image URL -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Image URL</label>
                        <input type="url" x-model="formData.featured_image" class="admin-input" placeholder="https://example.com/image.jpg">
                        <p class="text-xs text-gray-500 mt-1">Paste an image URL from Unsplash, Pexels, or upload to your server</p>
                    </div>
                    
                    <!-- Image Preview -->
                    <template x-if="formData.featured_image">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Image Preview</label>
                            <img :src="formData.featured_image" alt="Preview" class="w-full h-48 object-cover rounded-lg">
                        </div>
                    </template>
                    
                    <!-- Toggles -->
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" x-model="formData.is_organic_certified" class="w-5 h-5 rounded">
                            <span class="text-sm font-semibold">Organic Product üåø</span>
                        </label>
                        
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" x-model="formData.is_featured" class="w-5 h-5 rounded">
                            <span class="text-sm font-semibold">Featured ‚≠ê</span>
                        </label>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="flex gap-4 pt-4">
                        <button type="button" @click="closeModal()" class="flex-1 px-4 py-3 border border-gray-600 rounded-lg hover:bg-gray-800 transition font-semibold">
                            Cancel
                        </button>
                        <button type="submit" :disabled="saving" class="flex-1 admin-btn-primary disabled:opacity-50">
                            <span x-show="!saving" x-text="editMode ? 'Update Product' : 'Add Product'"></span>
                            <span x-show="saving">Saving...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function productsManager() {
    return {
        loading: true,
        saving: false,
        products: [],
        categories: [],
        filters: {
            search: '',
            category: '',
            stock_quantity: ''
        },
        showModal: false,
        editMode: false,
        editingId: null,
        formData: {
            name: '',
            description: '',
            category: '',
            price: 0,
            discount_price: null,
            stock_quantity: 0,
            unit: 'KG',
            unit_value: 1,
            low_stock_threshold: 10,
            is_active: true,
            is_featured: false,
            is_organic_certified: true,
            featured_image: ''
        },
        
        async init() {
            await this.loadCategories();
            await this.loadProducts();
        },
        
        async loadCategories() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch('/api/admin/categories', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    this.categories = await response.json();
                }
            } catch (err) {
                console.error('Failed to load categories', err);
            }
        },
        
        async loadProducts() {
            this.loading = true;
            const token = localStorage.getItem('access_token');
            const params = new URLSearchParams();
            if (this.filters.search) params.append('search', this.filters.search);
            if (this.filters.category) params.append('category', this.filters.category);
            if (this.filters.stock_quantity) params.append('stock_quantity', this.filters.stock_quantity);
            
            try {
                const response = await fetch(`/api/admin/products?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    this.products = data.products;
                }
            } catch (err) {
                console.error('Failed to load products', err);
            } finally {
                this.loading = false;
            }
        },
        
        openAddModal() {
            this.editMode = false;
            this.editingId = null;
            this.formData = {
                name: '',
                description: '',
                category: '',
                price: 0,
                discount_price: null,
                stock_quantity: 0,
                unit: 'KG',
                unit_value: 1,
                low_stock_threshold: 10,
                is_active: true,
                is_featured: false,
                is_organic_certified: true,
                featured_image: ''
            };
            this.showModal = true;
        },
        
        openEditModal(product) {
            this.editMode = true;
            this.editingId = product.id;
            this.formData = {
                name: product.name,
                description: product.description,
                category: product.category,
                price: parseFloat(product.price),
                discount_price: product.discount_price ? parseFloat(product.discount_price) : null,
                stock_quantity: product.stock_quantity,
                unit: product.unit,
                unit_value: product.unit_value,
                low_stock_threshold: product.low_stock_threshold || 10,
                is_active: product.is_active,
                is_featured: product.is_featured,
                is_organic_certified: product.is_organic_certified,
                featured_image: product.featured_image || ''
            };
            this.showModal = true;
        },
        
        closeModal() {
            this.showModal = false;
        },
        
        async saveProduct() {
			this.saving = true;
			const token = localStorage.getItem('access_token');
			const csrftoken = getCookie('csrftoken');

			// Use different URL endpoint for creation
			const url = this.editMode 
				? `/api/admin/products/update/${this.editingId}`
				: '/api/admin/products/create';
			<!-- @router.put('/products/update/{pk}') -->

			const method = this.editMode ? 'PUT' : 'POST';
			
			// Prepare payload, ensure null for empty optional fields
            // const payload = { ...this.formData };
            // if (!payload.discount_price) payload.discount_price = null;
            // if (!payload.featured_image) payload.featured_image = null;
			
			try {
				const response = await fetch(url, {
					method: method,
					credentials: 'include',
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json',
						'X-CSRFToken': csrftoken
					},
					body: JSON.stringify(this.formData)
				});
				const data = await response.json();
				if (data.success) {
					if (window.showNotification) window.showNotification(data.message, 'success');
					this.closeModal();
					await this.loadProducts();
				} else {
					if (window.showNotification) window.showNotification(data.message || 'Failed to save product', 'error');
				}
			} catch (err) {
				console.error('Failed to save product', err);
				if (window.showNotification) window.showNotification('Error saving product', 'error');
			} finally {
				this.saving = false;
				this.closeModal();
				await this.loadProducts();
			}
		},
        
        async deleteProduct(product) {
            if (!confirm(`Are you sure you want to delete "${product.name}"?`)) {
                return;
            }
            
            const token = localStorage.getItem('access_token');
            const csrftoken = getCookie('csrftoken');
            
            try {
                const response = await fetch(`/api/admin/products/${product.id}`, {
                    method: 'DELETE',
                    credentials: 'include',  // For session auth cookies & CSRF token
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'X-CSRFToken': csrftoken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (window.showNotification) {
                        window.showNotification(data.message, 'success');
                    }
                    await this.loadProducts();
                }
            } catch (err) {
                console.error('Failed to delete product', err);
                if (window.showNotification) {
                    window.showNotification('Error deleting product', 'error');
                }
            }
        }
    }
}
</script>

{% endblock %}
